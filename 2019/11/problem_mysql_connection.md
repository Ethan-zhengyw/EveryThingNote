# Flask+Sqlalchemy 连接池耗尽问题

# 问题描述
服务运行一段时间后，出现前端页面加载不出的现象

# 排查
1. 查看浏览器请求后端服务的HTTP请求日志，发现请求长时间无结果返回
2. 查看服务端日志，发现日志中打印：TimeoutError: QueuePool limit of size 20 overflow 10 reached, connection timed out, timeout 30

# 原因
系统中的部分功能使用多线程完成业务，在线程中原本并没有进行数据库的访问，但为了实现新特性，【引入了数据库访问】，且没有对数据库连接进行释放，导致系统执行一段时间后数据库连接池耗尽，无法处理新的请求。

# 解决方案

方案一、避免在线程中进行非必要的数据库访问
* 线程不访问数据库
* 线程也不访问由【其他session】得到的ORM对象

方案二、为线程申请新的数据库连接并在退出时释放
* 如果线程需要访问数据库，需重新从session中获取连接，并在线程退出前【释放连接】

缺点：如果线程需要执行较长的时间，那么会一直占用该连接，对于需要启动大量线程的场景，依然可能导致数据库连接池耗尽

方案三、缩小数据库访问范围，缩短数据库连接占有时间，用完即释放
* 将线程中对数据库访问的代码段抽封装在函数中
* 使用【自动释放数据库连接】的【装饰器】装饰涉及数据库访问的方法
